节能控制
++++++++++++

概述
==========

    .. 传送至\ 实验_\ 

    节能控制是指通过对负载电器设备的用电情况施加外部控制,以实现节能电力能源的目标. 当前系统中, 节能控制主指 *控制器* 对空调机的运行数据采集和运算。
    当预设条件发生后,控制器将采取一系列的可用控制指令/行为对空调机的运行情况施加干预,以实现空调机的制冷 停止 开机 关机操作。

    节能相关操作页面
        .. image:: /_static/imags/platform_ops/ps-on_offj.png
            :width: 80%
    
    在目标控制器的 \ **运行状态**\  页中, 每台空调配有 \|\ *空调通电状态*\  \| \ *压缩机运行状态*\  \| \ *节能状态*\ \|功能选项。
    除此之外, 还有一系列\ :ref:`节能配置`\ 作为控制器运行节能的参考指标使用, 在控制器运行过程中,通过网络分发至每个控制器。

节能操作及约束
================

节能操作
==========

          *如图所示，* **\ 压缩机运行状态： 运行  待机**\ , 将在后续版本中修改为  **开关机:   开机   关机**\ ,文档中使用 开关机:开机 关机 组合。

        - **空调通电状态:** 如上图所示, 此项包含 "通电"、"断电" 两个选项, 
          通电 表示下发断电指令, 下发后该指令将通过控制器转发至采集器完成空调机进电开启。
          断电 将会触发采集器执行断电操作, 成功后空调机进电关闭。
        - **开关机:** 包含"开机"、"关机" 两个选项, 当运行指令下发后, 空调机执行"空调开机", 当"关机"指令下发后, 空调机执行"空调关机" "空调待机" *(与空调机定义相关)*\ 。
        - **节能状态:** 有"开启"、"关闭"两个选项, 选中开启后, 控制器将参考\ :ref:`节能配置`\ 对空调机的工作状态实施控制. 选中"关闭"后, 
          控制器将放弃对空调机的自动控制 *(平台手动下发命令有效)*。

操作约束
==============

        控制器版本：\ **<=SECO_KSW_001_CO_01_31_250113**\ 

        操作约束是指，\ **节能**\ 自动运行期间因自动运行的逻辑限制，可能导致部分\ *手动命令*\ 不能生效的情况。手动命令可否执行的参考下表:

        * 节能状态"关闭"时 \ *可参考用例*\ \ :ref:`2100 [指令控制分合闸] 节能关闭`\ 

                +--------------------+--------------------+
                |    空调通电状态    |    最小执行周期    |
                +====================+====================+
                +        通电        +         30s        +
                +--------------------+--------------------+
                +        断电        +         30s        +
                +--------------------+--------------------+

                +--------------------+--------------------+
                |   压缩机运行状态   |    最小执行周期    |
                +====================+====================+
                +      运行          +         30s        +
                +--------------------+--------------------+
                +      待机          +         30s        +
                +--------------------+--------------------+


        * 节能状态"开启"时

                节能开启后， 下发“空调通电状态”、“压缩机运行状态” 的状态，受到控制器“节能控制”的运算影响，手动下发的指令\ **不受保障**\ 。
                
                \ *如： 当空调机处于运行状态时， 平台下发“断电”指令， 控制器收到指令后将等待空调机待机/关机后才会执行“断电”， 
                如空调机总是处于“制冷”工作时，将导致“断电”命令永不被执行*\ 

        * 当控制器通电且节能开启时

                -  不能操作 **开关机** 的原因在于：节能逻辑接管空调期间，以环境温度是否达到关机水平为最优先，当环境温度居高不下时， **关机** 命令会被搁置，得不到执行。
                -  不能操作 **断电** 的原因在于：当空调机运行且压缩机运转期间，断电的操作有可能损坏空调的核心-压缩机，故在 **断电** 不可被执行。

节能状态-退出
=================

	当控制器配置了节能模开启，即工作在节能模式下，依据平台下发的节能策略(配置)自动运行。当平台设置节能关闭后，控制器将不再接管空调的运行。
	除上述平台中手动下发节能关闭外，可配置“当有人进入后”联动节能关闭。

	**有人进入节能关闭**

		#. 平台中 "人体感应光线阈值（区间开始值）" 及 “人体感应光线阈值（区间结束值）” 。
			* 二者均为0时，将不影响"有人进入" 条件成立。
			* 二者不为0且有效时(前者小于后者)，采集光线的值将成为”有人进入" 成立的一个条件。			
		#. 平台开启 "有人自动退出节能模式开关“
		#. 平台开启 "人体感应开关"

		当判断有人进场，为了不影响人工操作，控制器将退出节能模式，并且发送开机指令。

	**举例1**
		* 条件
			#. 节能"工作温度上限" = 27℃, “工作温度下限” = 20℃ 。
			#. 空调机节能开启，"人体感应光线阈值"==0、 “人体感应光线阈值” == 1000。
			#. “有人自动退出节能模式开关" == 开启
			#. “人体感应开关” == 开启

		* 预期
			#. 空调机的运行受控于控制器的节能策略。
				a. 当回风/环境温度高于27℃，空调机将自动运行。
				b. 当回风/环境温度低于20℃，空调机将关机。
			#. 当人体(有形实体)靠近人体传感器，且保持晃动大于2分钟后，空调机将开机(如已关机)且设置制冷温度（关闭节能后空调温度设定值），持续运行直到人员离场。
			#. 人员离开后，持续10分钟无人/光线值不在设定范围，判定为“人员离场” 空调机将再次受控于节能模式。
	
	**举例2**
		* 条件
			#. 节能"工作温度上限" = 27℃, “工作温度下限” = 20℃ 。
			#. 空调机节能开启，"人体感应光线阈值"==0、 “人体感应光线阈值” == 0。
			#. “有人自动退出节能模式开关" == 开启
			#. “人体感应开关” == 开启

		* 预期
			#. 空调机的运行受控于控制器的节能策略。
				a. 当回风/环境温度高于27℃，空调机将自动运行。
				b. 当回风/环境温度低于20℃，空调机将关机。
			#. 当人体(有形实体)靠近人体传感器，且保持晃动大于2分钟后，空调机将开机(如已关机)且设置制冷温度（关闭节能后空调温度设定值），持续运行直到人员离场。
			#. 人员离开后，持续10分钟无人，判定为“人员离场” 空调机将再次受控于节能模式。

		
节能开启-开关机状态恢复
=======================
        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        空调机开机运行过程，平台下发关机/手动按键关机，节能策略应当在5分钟内执行开机。
        
        工作温度上限、下限之内时，节能策略不会恢复开关机状态。


节能开启-空调关机后断电
=========================

        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        平台上勾选\ **节能模式是否关机断电**\ 后，当空调工作温度低于\ *工作温度下限值*\ ,空调关机并且在1分钟内采集器分闸。

        - 此功能仅在节能开启时生效。
        - 当节能开启时，自动关机或手动通过平台下发关机，此功能均生效。

        举例: **关机后自动断电**

		* 平台设置空调机节能开启，工作上限27℃， 工作下限温度20℃，环境温度18℃（不会触发空调机自动运行）
		* 平台设置空调机关机后断电(选中/使能)
		* 开启热风直吹空调机回风温度传感器。

		* 结果：
			#. 回风温度上升至27℃后，空调机启动。（节能控制）
			#. 回风温度下降至20℃后，空调机关机。（节能控制）
			#. 2后，开始计时，2分钟内（典型值）空调机将分闸断电。

节能开启-空调开机前通电
=========================

        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        平台上勾选\ **节能模式是否关机断电**\ 后，当空调工作温度低于\ *工作温度下限值*\ ,空调关机并且在1分钟内采集器分闸。

        - 此功能仅在节能开启时生效。
        - 当节能开启时，自动关机或手动通过平台下发关机，此功能均生效。

        举例: **开机前，自动通电**

			* 平台设置空调机节能开启，工作上限27℃， 工作下限温度20℃，环境温度18℃（不会触发空调机自动运行）
			* 平台设置空调机关机后断电(选中/使能)
			* 开启热风直吹空调机回风温度传感器。
			* 结果： 
				空调机关机状态，当回风温度上升至27℃，采集器先执行了合闸操作，30s内执行了开机操作，空调机成功开机。

强制断电
=========

		控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

		强制断电功能使用的背景是，当控制器判断空调压缩机正在运行时，对于平台下发的“分闸”指令不会立即执行，目的在于保护空调压缩机。
		当有些场景，必须执行分闸断电时，使能此开关后，控制器收到“分闸”指令会立即执行。

		现场有些空调机，待机时其功率依然很大，无法降低。遇到此种情况，如空调机上电后能够自动开机，可通过此功能实现节能效果。

		** 当存在需要分闸断电的场景时，此功能生效。
		
		节能开启时：
			
			* 使能强制断电
			* 环境温度降至工作温度下限后，控制器尝试关机，关机失败后（重试3次），将执行分闸断电。
		
			场景举例: 节能开启时，回风温度降至工作温度以下

				* 平台设置空调机节能开启，工作上限27℃， 工作下限温度20℃，环境温度18℃（不会触发空调机自动运行）
				* 平台设置空调机关机后断电(选中/使能)
				* 开启热风直吹空调机回风温度传感器。
				* 开启 **是否强制断电** 
				* 开启热风直吹空调机回风温度传感器。
				* 空调机运行后，关闭热风、拔掉红外传感器
				* 结果： 
					回风温度降至工作温度下限后，空调机不能关机。3分钟后采集器分闸，空调机断电。

		节能关闭时：
			
			* 使能 **强制断电** 
			* 空调开机状态
			* 平台下发分闸操作，控制器将立刻分闸。对比 *未选择强制断电* 时，控制器将等待空调机关机后执行分闸操作（此过程可能等待较长时间）。
			* 结果： 
				平台下发分闸操作后，控制器立刻控制采集器分闸。

强制开关机、分闸
=================

        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        *此前版本中，下发开关机/分合闸指令到控制器。接到指令后控制器会采集空调机功率，以此为依据处理是否执行 开关机/分(合)闸命令，且等待时长不确定。在安装调试过程，因不能即使测出系统的工作状态，特增加 *\  **强制** 选项。
        \ *位于平台的操控页面，以复选框形式出现，默认不够选。*\ 

        * 使用限制，此功能目的在于方便调试，有以下使用约束。

			#. 目标空调的节能模式，必须处于\ **关闭**\ 状态
			#. 在平台页面勾选\ **强制**\ 选框
			#. 仅限调试用，调试完毕后应当及时取消勾选\ **强制**\ 选框

高温保护
==========

        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        空调机处于关机状态（典型场景， 人员进入后操作关机， 离开前未将空调开机），当回风温度上升至预设温度后，控制器将识别为“高温保护”状态，控制器将尝试开启空调。
        平台可配置参数有空调高温保护温度、空调高温保护解除温度、空调高温保护时间：

                * 空调高温保护温度： 当回风温度持续上升，且高于此值后准备高温保护模式。
                * 空调高温保护解除温度： 当回风温度降低至此值后，将退出高温保护模式。
                * 空调高温保护时间： 表示高温保护模式持续的时间，超过此值后，将操作空调机开机。
                * e.g.: 空调高温保护温度设置为 36, 保护解除温度设置为30, 保护时间为0 (0==30分钟)。

                        当空调机关机状态下，回风温度超过36度，且持续时长超过30分钟，控制器将开启空调机制冷。

                        当回风温度降至30度后，(节能关闭状态)空调机将继续保持开机状态，（节能开启状态）控制器进入节能模式，按照预设参数运行。

系统重启-资源枯竭
=================

        控制器版本：\ **>SECO_KSW_001_CO_01_33**\ 

        内存不足重启：当检测剩余内存少于45K后，系统执行重启。

        断网重启 : 当断网时长超过1小时，系统执行重启。
        
        4G-LTE : 当SIM被热插拔后，将引起断网，在4G组件中增加断网后30s重启模块、重新联网。

空调配置文件清空
=================

        控制器版本：\ **<=SECO_KSW_001_CO_01_33**\ 
        
        采集器下控制指令，需要依据不同的空调机配置生成，e.g.: 美的空调、格力空调、海悟空调 ... 。即便是同一品牌，也存在红外控制、485控制、信号量控制方式。
        平台下发控制指令前，应当对目标空调机选择适当的配置文件(LUA), 此文件将被下发之控制器。每当下发文件后，控制器将持久化并且按需调用。
        当配置文件增多后，将会影响存储、消耗更多内存用于文件的遍历和选择，为减少对资源消耗。当新配置文件的下载信息到达控制器后，控制器将按照配置中的lua名称过滤已缓存的lua文件，对不在配置中的文件执行删除操作。


人体及光线
===========

		相关告警参考 
			* :ref:`环境异常`

        人体传感器:
			* 无人判定: 当未感应到人体存在且持续长 > 3分钟。 
			* 有人判定: 当有人(有形物体)移动，且持续时长 > 5秒钟。
			* 数据内容: 人体存在与否的标记值、光线值。
			* 数据上传: 无人时周期为30分钟、有人时周期为2分钟。

        光线传感器:
			* 数据内容: 人体存在的状态值，光线值。
			* 数据上传: 光线每2秒刷新一次，当相邻两次采样光线差值 >= 200， 触发。


		平台配置:
			* 人体感应光线阈值: 平台可配 人体感应光线阈值-开始值，人体感应光线阈值-结束值。
				- 光线值取值范围 0-1000, 当二者任一为0时，光线值配置无效

			* 人体与光线，优先级说明:
				- 当光线值配置有效时，环境光线值处于配置范围，即\ **认定为有人**\ 
